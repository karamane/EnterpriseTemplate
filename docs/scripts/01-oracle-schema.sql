-- ============================================
-- Oracle DDL Scripts
-- Enterprise Template
-- Version: 2.0.0
-- Date: 2025-12-05
-- ============================================
-- Execution Order:
--   1. Drop existing objects (optional)
--   2. Business Tables (CUSTOMERS, ORDERS, ORDER_ITEMS)
--   3. Auth Tables (USERS, REFRESH_TOKENS)
--   4. Log Tables (LOG_*)
--   5. Views
--   6. Seed Data (Demo Users)
-- ============================================

-- ============================================
-- SECTION 1: DROP EXISTING OBJECTS (Optional)
-- ============================================
/*
-- Uncomment to drop existing tables before recreation
BEGIN EXECUTE IMMEDIATE 'DROP TABLE ORDER_ITEMS CASCADE CONSTRAINTS'; EXCEPTION WHEN OTHERS THEN IF SQLCODE != -942 THEN RAISE; END IF; END;
/
BEGIN EXECUTE IMMEDIATE 'DROP TABLE ORDERS CASCADE CONSTRAINTS'; EXCEPTION WHEN OTHERS THEN IF SQLCODE != -942 THEN RAISE; END IF; END;
/
BEGIN EXECUTE IMMEDIATE 'DROP TABLE CUSTOMERS CASCADE CONSTRAINTS'; EXCEPTION WHEN OTHERS THEN IF SQLCODE != -942 THEN RAISE; END IF; END;
/
BEGIN EXECUTE IMMEDIATE 'DROP TABLE REFRESH_TOKENS CASCADE CONSTRAINTS'; EXCEPTION WHEN OTHERS THEN IF SQLCODE != -942 THEN RAISE; END IF; END;
/
BEGIN EXECUTE IMMEDIATE 'DROP TABLE USERS CASCADE CONSTRAINTS'; EXCEPTION WHEN OTHERS THEN IF SQLCODE != -942 THEN RAISE; END IF; END;
/
BEGIN EXECUTE IMMEDIATE 'DROP TABLE LOG_REQUEST_LOGS CASCADE CONSTRAINTS'; EXCEPTION WHEN OTHERS THEN IF SQLCODE != -942 THEN RAISE; END IF; END;
/
BEGIN EXECUTE IMMEDIATE 'DROP TABLE LOG_RESPONSE_LOGS CASCADE CONSTRAINTS'; EXCEPTION WHEN OTHERS THEN IF SQLCODE != -942 THEN RAISE; END IF; END;
/
BEGIN EXECUTE IMMEDIATE 'DROP TABLE LOG_EXCEPTION_LOGS CASCADE CONSTRAINTS'; EXCEPTION WHEN OTHERS THEN IF SQLCODE != -942 THEN RAISE; END IF; END;
/
BEGIN EXECUTE IMMEDIATE 'DROP TABLE LOG_BUSINESS_EXCEPTION_LOGS CASCADE CONSTRAINTS'; EXCEPTION WHEN OTHERS THEN IF SQLCODE != -942 THEN RAISE; END IF; END;
/
BEGIN EXECUTE IMMEDIATE 'DROP TABLE LOG_AUDIT_LOGS CASCADE CONSTRAINTS'; EXCEPTION WHEN OTHERS THEN IF SQLCODE != -942 THEN RAISE; END IF; END;
/
*/

-- ============================================
-- SECTION 2: BUSINESS TABLES
-- ============================================

-- ============================================
-- 2.1 CUSTOMERS Table
-- ============================================
CREATE TABLE CUSTOMERS (
    ID                      NUMBER(19)      GENERATED BY DEFAULT AS IDENTITY NOT NULL,
    FIRST_NAME              VARCHAR2(100)   NOT NULL,
    LAST_NAME               VARCHAR2(100)   NOT NULL,
    EMAIL                   VARCHAR2(256)   NOT NULL,
    PHONE_NUMBER            VARCHAR2(20),
    IS_ACTIVE               NUMBER(1)       DEFAULT 1 NOT NULL,
    REGISTERED_AT           TIMESTAMP       NOT NULL,
    CREATED_AT              TIMESTAMP       NOT NULL,
    CREATED_BY              VARCHAR2(100),
    UPDATED_AT              TIMESTAMP,
    UPDATED_BY              VARCHAR2(100),
    IS_DELETED              NUMBER(1)       DEFAULT 0,
    DELETED_AT              TIMESTAMP,
    DELETED_BY              VARCHAR2(100),
    CONSTRAINT PK_CUSTOMERS PRIMARY KEY (ID)
);

COMMENT ON TABLE CUSTOMERS IS 'Müşteri bilgileri tablosu';
COMMENT ON COLUMN CUSTOMERS.ID IS 'Unique müşteri ID (Auto-increment)';
COMMENT ON COLUMN CUSTOMERS.FIRST_NAME IS 'Müşteri adı';
COMMENT ON COLUMN CUSTOMERS.LAST_NAME IS 'Müşteri soyadı';
COMMENT ON COLUMN CUSTOMERS.EMAIL IS 'E-posta adresi';
COMMENT ON COLUMN CUSTOMERS.PHONE_NUMBER IS 'Telefon numarası';
COMMENT ON COLUMN CUSTOMERS.IS_ACTIVE IS 'Aktif mi? (1=Evet, 0=Hayır)';
COMMENT ON COLUMN CUSTOMERS.REGISTERED_AT IS 'Kayıt tarihi';
COMMENT ON COLUMN CUSTOMERS.IS_DELETED IS 'Silinmiş mi? (Soft delete)';

CREATE UNIQUE INDEX IDX_CUSTOMERS_EMAIL ON CUSTOMERS(EMAIL);
CREATE INDEX IDX_CUSTOMERS_IS_DELETED ON CUSTOMERS(IS_DELETED);
CREATE INDEX IDX_CUSTOMERS_IS_ACTIVE ON CUSTOMERS(IS_ACTIVE);

-- ============================================
-- 2.2 ORDERS Table
-- ============================================
CREATE TABLE ORDERS (
    ID                      NUMBER(19)      GENERATED BY DEFAULT AS IDENTITY NOT NULL,
    CUSTOMER_ID             NUMBER(19)      NOT NULL,
    TOTAL_AMOUNT            NUMBER(18,2)    NOT NULL,
    STATUS                  VARCHAR2(50)    DEFAULT 'Pending' NOT NULL,
    NOTES                   VARCHAR2(500),
    ORDER_DATE              TIMESTAMP       DEFAULT SYSTIMESTAMP NOT NULL,
    CREATED_AT              TIMESTAMP       DEFAULT SYSTIMESTAMP NOT NULL,
    CREATED_BY              VARCHAR2(100),
    UPDATED_AT              TIMESTAMP,
    UPDATED_BY              VARCHAR2(100),
    IS_DELETED              NUMBER(1)       DEFAULT 0 NOT NULL,
    DELETED_AT              TIMESTAMP,
    DELETED_BY              VARCHAR2(100),
    CONSTRAINT PK_ORDERS PRIMARY KEY (ID),
    CONSTRAINT FK_ORDERS_CUSTOMER FOREIGN KEY (CUSTOMER_ID) REFERENCES CUSTOMERS(ID)
);

COMMENT ON TABLE ORDERS IS 'Sipariş bilgileri tablosu';
COMMENT ON COLUMN ORDERS.ID IS 'Unique sipariş ID (Auto-increment)';
COMMENT ON COLUMN ORDERS.CUSTOMER_ID IS 'İlişkili müşteri ID';
COMMENT ON COLUMN ORDERS.TOTAL_AMOUNT IS 'Toplam tutar';
COMMENT ON COLUMN ORDERS.STATUS IS 'Sipariş durumu (Pending, Confirmed, Shipped, Delivered, Cancelled)';
COMMENT ON COLUMN ORDERS.NOTES IS 'Sipariş notları';
COMMENT ON COLUMN ORDERS.ORDER_DATE IS 'Sipariş tarihi';

CREATE INDEX IDX_ORDERS_CUSTOMER ON ORDERS(CUSTOMER_ID);
CREATE INDEX IDX_ORDERS_STATUS ON ORDERS(STATUS);
CREATE INDEX IDX_ORDERS_DATE ON ORDERS(ORDER_DATE);
CREATE INDEX IDX_ORDERS_IS_DELETED ON ORDERS(IS_DELETED);

-- ============================================
-- 2.3 ORDER_ITEMS Table
-- ============================================
CREATE TABLE ORDER_ITEMS (
    ID                      NUMBER(19)      GENERATED BY DEFAULT AS IDENTITY NOT NULL,
    ORDER_ID                NUMBER(19)      NOT NULL,
    PRODUCT_ID              NUMBER(10)      NOT NULL,
    PRODUCT_NAME            VARCHAR2(200)   NOT NULL,
    QUANTITY                NUMBER(10)      NOT NULL,
    UNIT_PRICE              NUMBER(18,2)    NOT NULL,
    CREATED_AT              TIMESTAMP       DEFAULT SYSTIMESTAMP NOT NULL,
    CREATED_BY              VARCHAR2(100),
    UPDATED_AT              TIMESTAMP,
    UPDATED_BY              VARCHAR2(100),
    CONSTRAINT PK_ORDER_ITEMS PRIMARY KEY (ID),
    CONSTRAINT FK_ORDER_ITEMS_ORDER FOREIGN KEY (ORDER_ID) REFERENCES ORDERS(ID)
);

COMMENT ON TABLE ORDER_ITEMS IS 'Sipariş kalemleri tablosu';
COMMENT ON COLUMN ORDER_ITEMS.ID IS 'Unique kalem ID (Auto-increment)';
COMMENT ON COLUMN ORDER_ITEMS.ORDER_ID IS 'İlişkili sipariş ID';
COMMENT ON COLUMN ORDER_ITEMS.PRODUCT_ID IS 'Ürün ID';
COMMENT ON COLUMN ORDER_ITEMS.PRODUCT_NAME IS 'Ürün adı';
COMMENT ON COLUMN ORDER_ITEMS.QUANTITY IS 'Miktar';
COMMENT ON COLUMN ORDER_ITEMS.UNIT_PRICE IS 'Birim fiyat';

CREATE INDEX IDX_ORDER_ITEMS_ORDER ON ORDER_ITEMS(ORDER_ID);
CREATE INDEX IDX_ORDER_ITEMS_PRODUCT ON ORDER_ITEMS(PRODUCT_ID);

-- ============================================
-- SECTION 3: AUTH TABLES
-- ============================================

-- ============================================
-- 3.1 USERS Table
-- ============================================
CREATE TABLE USERS (
    ID                      NUMBER(19)      GENERATED BY DEFAULT AS IDENTITY NOT NULL,
    USERNAME                VARCHAR2(100)   NOT NULL,
    PASSWORD_HASH           VARCHAR2(256)   NOT NULL,
    EMAIL                   VARCHAR2(256)   NOT NULL,
    FULL_NAME               VARCHAR2(200),
    ROLES                   VARCHAR2(500),
    IS_ACTIVE               NUMBER(1)       DEFAULT 1 NOT NULL,
    LAST_LOGIN_AT           TIMESTAMP,
    CREATED_AT              TIMESTAMP       DEFAULT SYSTIMESTAMP NOT NULL,
    CREATED_BY              VARCHAR2(100),
    UPDATED_AT              TIMESTAMP,
    UPDATED_BY              VARCHAR2(100),
    IS_DELETED              NUMBER(1)       DEFAULT 0 NOT NULL,
    DELETED_AT              TIMESTAMP,
    DELETED_BY              VARCHAR2(100),
    CONSTRAINT PK_USERS PRIMARY KEY (ID)
);

COMMENT ON TABLE USERS IS 'Kullanıcı bilgileri tablosu';
COMMENT ON COLUMN USERS.ID IS 'Unique kullanıcı ID (Auto-increment)';
COMMENT ON COLUMN USERS.USERNAME IS 'Kullanıcı adı (unique)';
COMMENT ON COLUMN USERS.PASSWORD_HASH IS 'Şifre hash (BCrypt)';
COMMENT ON COLUMN USERS.EMAIL IS 'E-posta adresi (unique)';
COMMENT ON COLUMN USERS.FULL_NAME IS 'Tam ad';
COMMENT ON COLUMN USERS.ROLES IS 'Roller (comma-separated: Admin,User)';
COMMENT ON COLUMN USERS.IS_ACTIVE IS 'Aktif mi? (1=Evet, 0=Hayır)';
COMMENT ON COLUMN USERS.LAST_LOGIN_AT IS 'Son giriş tarihi';

CREATE UNIQUE INDEX IDX_USERS_USERNAME ON USERS(USERNAME);
CREATE UNIQUE INDEX IDX_USERS_EMAIL ON USERS(EMAIL);
CREATE INDEX IDX_USERS_IS_ACTIVE ON USERS(IS_ACTIVE);
CREATE INDEX IDX_USERS_IS_DELETED ON USERS(IS_DELETED);

-- ============================================
-- 3.2 REFRESH_TOKENS Table
-- ============================================
CREATE TABLE REFRESH_TOKENS (
    ID                      NUMBER(19)      GENERATED BY DEFAULT AS IDENTITY NOT NULL,
    USER_ID                 NUMBER(19)      NOT NULL,
    TOKEN                   VARCHAR2(500)   NOT NULL,
    EXPIRES_AT              TIMESTAMP       NOT NULL,
    CREATED_AT              TIMESTAMP       DEFAULT SYSTIMESTAMP NOT NULL,
    CREATED_BY_IP           VARCHAR2(50),
    REVOKED_AT              TIMESTAMP,
    REVOKED_BY_IP           VARCHAR2(50),
    REPLACED_BY_TOKEN       VARCHAR2(500),
    REVOKED_REASON          VARCHAR2(500),
    CONSTRAINT PK_REFRESH_TOKENS PRIMARY KEY (ID),
    CONSTRAINT FK_REFRESH_TOKENS_USER FOREIGN KEY (USER_ID) REFERENCES USERS(ID) ON DELETE CASCADE
);

COMMENT ON TABLE REFRESH_TOKENS IS 'Refresh token kayıtları';
COMMENT ON COLUMN REFRESH_TOKENS.ID IS 'Unique token ID (Auto-increment)';
COMMENT ON COLUMN REFRESH_TOKENS.USER_ID IS 'İlişkili kullanıcı ID';
COMMENT ON COLUMN REFRESH_TOKENS.TOKEN IS 'Refresh token değeri';
COMMENT ON COLUMN REFRESH_TOKENS.EXPIRES_AT IS 'Token son kullanma tarihi';
COMMENT ON COLUMN REFRESH_TOKENS.REVOKED_AT IS 'Token iptal tarihi';
COMMENT ON COLUMN REFRESH_TOKENS.REPLACED_BY_TOKEN IS 'Yeni token ile değiştirildiyse yeni token';

CREATE INDEX IDX_REFRESH_TOKENS_USER ON REFRESH_TOKENS(USER_ID);
CREATE UNIQUE INDEX IDX_REFRESH_TOKENS_TOKEN ON REFRESH_TOKENS(TOKEN);
CREATE INDEX IDX_REFRESH_TOKENS_EXPIRES ON REFRESH_TOKENS(EXPIRES_AT);

-- ============================================
-- SECTION 4: LOG TABLES
-- ============================================

-- ============================================
-- 4.1 LOG_REQUEST_LOGS - HTTP Request bilgileri
-- ============================================
CREATE TABLE LOG_REQUEST_LOGS (
    LOG_ID                  VARCHAR2(36)    NOT NULL,
    CORRELATION_ID          VARCHAR2(36)    NOT NULL,
    TIMESTAMP               TIMESTAMP       NOT NULL,
    HTTP_METHOD             VARCHAR2(10),
    REQUEST_PATH            VARCHAR2(2000),
    QUERY_STRING            VARCHAR2(4000),
    REQUEST_BODY            CLOB,
    REQUEST_HEADERS         CLOB,
    CONTENT_TYPE            VARCHAR2(200),
    CONTENT_LENGTH          NUMBER(19),
    CLIENT_IP               VARCHAR2(50),
    USER_AGENT              VARCHAR2(500),
    USER_ID                 VARCHAR2(100),
    LAYER                   VARCHAR2(50),
    SERVER_NAME             VARCHAR2(100),
    APPLICATION_NAME        VARCHAR2(100),
    CONSTRAINT PK_LOG_REQUEST_LOGS PRIMARY KEY (LOG_ID)
);

COMMENT ON TABLE LOG_REQUEST_LOGS IS 'HTTP Request log kayıtları';

CREATE INDEX IDX_REQUEST_LOGS_CORRELATION ON LOG_REQUEST_LOGS(CORRELATION_ID);
CREATE INDEX IDX_REQUEST_LOGS_TIMESTAMP ON LOG_REQUEST_LOGS(TIMESTAMP);
CREATE INDEX IDX_REQUEST_LOGS_USER ON LOG_REQUEST_LOGS(USER_ID);
CREATE INDEX IDX_REQUEST_LOGS_PATH ON LOG_REQUEST_LOGS(REQUEST_PATH);

-- ============================================
-- 4.2 LOG_RESPONSE_LOGS - HTTP Response bilgileri
-- ============================================
CREATE TABLE LOG_RESPONSE_LOGS (
    LOG_ID                  VARCHAR2(36)    NOT NULL,
    CORRELATION_ID          VARCHAR2(36)    NOT NULL,
    REQUEST_LOG_ID          VARCHAR2(36),
    TIMESTAMP               TIMESTAMP       NOT NULL,
    STATUS_CODE             NUMBER(5),
    DURATION_MS             NUMBER(19),
    RESPONSE_BODY           CLOB,
    CONTENT_TYPE            VARCHAR2(200),
    DB_QUERY_COUNT          NUMBER(10),
    DB_QUERY_DURATION_MS    NUMBER(19),
    CACHE_HIT_COUNT         NUMBER(10),
    CACHE_MISS_COUNT        NUMBER(10),
    LAYER                   VARCHAR2(50),
    SERVER_NAME             VARCHAR2(100),
    APPLICATION_NAME        VARCHAR2(100),
    CONSTRAINT PK_LOG_RESPONSE_LOGS PRIMARY KEY (LOG_ID)
);

COMMENT ON TABLE LOG_RESPONSE_LOGS IS 'HTTP Response log kayıtları';

CREATE INDEX IDX_RESPONSE_LOGS_CORRELATION ON LOG_RESPONSE_LOGS(CORRELATION_ID);
CREATE INDEX IDX_RESPONSE_LOGS_REQUEST ON LOG_RESPONSE_LOGS(REQUEST_LOG_ID);
CREATE INDEX IDX_RESPONSE_LOGS_TIMESTAMP ON LOG_RESPONSE_LOGS(TIMESTAMP);
CREATE INDEX IDX_RESPONSE_LOGS_STATUS ON LOG_RESPONSE_LOGS(STATUS_CODE);
CREATE INDEX IDX_RESPONSE_LOGS_DURATION ON LOG_RESPONSE_LOGS(DURATION_MS);

-- ============================================
-- 4.3 LOG_EXCEPTION_LOGS - Sistem hataları
-- ============================================
CREATE TABLE LOG_EXCEPTION_LOGS (
    LOG_ID                  VARCHAR2(36)    NOT NULL,
    CORRELATION_ID          VARCHAR2(36)    NOT NULL,
    TIMESTAMP               TIMESTAMP       NOT NULL,
    LOG_LEVEL               VARCHAR2(20),
    EXCEPTION_TYPE          VARCHAR2(500),
    EXCEPTION_MESSAGE       VARCHAR2(4000),
    STACK_TRACE             CLOB,
    SOURCE                  VARCHAR2(500),
    INNER_EXCEPTION_TYPE    VARCHAR2(500),
    INNER_EXCEPTION_MESSAGE VARCHAR2(4000),
    LAYER                   VARCHAR2(50),
    CLASS_NAME              VARCHAR2(500),
    METHOD_NAME             VARCHAR2(200),
    REQUEST_PATH            VARCHAR2(2000),
    HTTP_METHOD             VARCHAR2(10),
    EXCEPTION_CATEGORY      VARCHAR2(100),
    IS_HANDLED              NUMBER(1),
    IS_TRANSIENT            NUMBER(1),
    SERVER_NAME             VARCHAR2(100),
    CLIENT_IP               VARCHAR2(50),
    USER_ID                 VARCHAR2(100),
    APPLICATION_NAME        VARCHAR2(100),
    CONSTRAINT PK_LOG_EXCEPTION_LOGS PRIMARY KEY (LOG_ID)
);

COMMENT ON TABLE LOG_EXCEPTION_LOGS IS 'Exception/Hata log kayıtları';

CREATE INDEX IDX_EXCEPTION_LOGS_CORRELATION ON LOG_EXCEPTION_LOGS(CORRELATION_ID);
CREATE INDEX IDX_EXCEPTION_LOGS_TIMESTAMP ON LOG_EXCEPTION_LOGS(TIMESTAMP);
CREATE INDEX IDX_EXCEPTION_LOGS_TYPE ON LOG_EXCEPTION_LOGS(EXCEPTION_TYPE);
CREATE INDEX IDX_EXCEPTION_LOGS_LEVEL ON LOG_EXCEPTION_LOGS(LOG_LEVEL);
CREATE INDEX IDX_EXCEPTION_LOGS_CATEGORY ON LOG_EXCEPTION_LOGS(EXCEPTION_CATEGORY);

-- ============================================
-- 4.4 LOG_BUSINESS_EXCEPTION_LOGS - İş kuralı hataları
-- ============================================
CREATE TABLE LOG_BUSINESS_EXCEPTION_LOGS (
    LOG_ID                  VARCHAR2(36)    NOT NULL,
    CORRELATION_ID          VARCHAR2(36)    NOT NULL,
    TIMESTAMP               TIMESTAMP       NOT NULL,
    BUSINESS_OPERATION      VARCHAR2(200),
    BUSINESS_ERROR_CODE     VARCHAR2(50),
    BUSINESS_ERROR_MESSAGE  VARCHAR2(4000),
    USER_FRIENDLY_MESSAGE   VARCHAR2(2000),
    SUGGESTED_ACTION        VARCHAR2(1000),
    AFFECTED_ENTITY         VARCHAR2(200),
    AFFECTED_ENTITY_ID      VARCHAR2(100),
    RULE_NAME               VARCHAR2(200),
    VALIDATION_ERRORS       CLOB,
    LAYER                   VARCHAR2(50),
    CLASS_NAME              VARCHAR2(500),
    SERVER_NAME             VARCHAR2(100),
    CLIENT_IP               VARCHAR2(50),
    USER_ID                 VARCHAR2(100),
    APPLICATION_NAME        VARCHAR2(100),
    CONSTRAINT PK_LOG_BUSINESS_EXCEPTION PRIMARY KEY (LOG_ID)
);

COMMENT ON TABLE LOG_BUSINESS_EXCEPTION_LOGS IS 'İş kuralı hata log kayıtları';

CREATE INDEX IDX_BUS_EXC_LOGS_CORRELATION ON LOG_BUSINESS_EXCEPTION_LOGS(CORRELATION_ID);
CREATE INDEX IDX_BUS_EXC_LOGS_TIMESTAMP ON LOG_BUSINESS_EXCEPTION_LOGS(TIMESTAMP);
CREATE INDEX IDX_BUS_EXC_LOGS_ERROR_CODE ON LOG_BUSINESS_EXCEPTION_LOGS(BUSINESS_ERROR_CODE);
CREATE INDEX IDX_BUS_EXC_LOGS_OPERATION ON LOG_BUSINESS_EXCEPTION_LOGS(BUSINESS_OPERATION);
CREATE INDEX IDX_BUS_EXC_LOGS_ENTITY ON LOG_BUSINESS_EXCEPTION_LOGS(AFFECTED_ENTITY, AFFECTED_ENTITY_ID);

-- ============================================
-- 4.5 LOG_AUDIT_LOGS - Denetim kayıtları
-- ============================================
CREATE TABLE LOG_AUDIT_LOGS (
    LOG_ID                  VARCHAR2(36)    NOT NULL,
    CORRELATION_ID          VARCHAR2(36)    NOT NULL,
    TIMESTAMP               TIMESTAMP       NOT NULL,
    ACTION                  VARCHAR2(50),
    ENTITY_TYPE             VARCHAR2(200),
    ENTITY_ID               VARCHAR2(100),
    OLD_VALUES              CLOB,
    NEW_VALUES              CLOB,
    CHANGES                 CLOB,
    IS_SUCCESS              NUMBER(1),
    FAILURE_REASON          VARCHAR2(2000),
    DURATION_MS             NUMBER(19),
    LAYER                   VARCHAR2(50),
    USER_ID                 VARCHAR2(100),
    CLIENT_IP               VARCHAR2(50),
    SERVER_NAME             VARCHAR2(100),
    APPLICATION_NAME        VARCHAR2(100),
    CONSTRAINT PK_LOG_AUDIT_LOGS PRIMARY KEY (LOG_ID)
);

COMMENT ON TABLE LOG_AUDIT_LOGS IS 'Audit/Denetim log kayıtları';

CREATE INDEX IDX_AUDIT_LOGS_CORRELATION ON LOG_AUDIT_LOGS(CORRELATION_ID);
CREATE INDEX IDX_AUDIT_LOGS_TIMESTAMP ON LOG_AUDIT_LOGS(TIMESTAMP);
CREATE INDEX IDX_AUDIT_LOGS_ENTITY ON LOG_AUDIT_LOGS(ENTITY_TYPE, ENTITY_ID);
CREATE INDEX IDX_AUDIT_LOGS_USER ON LOG_AUDIT_LOGS(USER_ID);
CREATE INDEX IDX_AUDIT_LOGS_ACTION ON LOG_AUDIT_LOGS(ACTION);

-- ============================================
-- SECTION 5: VIEWS
-- ============================================

-- Son 24 saat hata özeti
CREATE OR REPLACE VIEW VW_EXCEPTION_SUMMARY_24H AS
SELECT 
    TRUNC(TIMESTAMP, 'HH') AS HOUR,
    EXCEPTION_TYPE,
    LOG_LEVEL,
    COUNT(*) AS ERROR_COUNT
FROM LOG_EXCEPTION_LOGS
WHERE TIMESTAMP > SYSTIMESTAMP - INTERVAL '24' HOUR
GROUP BY TRUNC(TIMESTAMP, 'HH'), EXCEPTION_TYPE, LOG_LEVEL
ORDER BY HOUR DESC, ERROR_COUNT DESC;

-- Request performans özeti
CREATE OR REPLACE VIEW VW_REQUEST_PERFORMANCE AS
SELECT 
    TRUNC(req.TIMESTAMP, 'HH') AS HOUR,
    req.REQUEST_PATH,
    COUNT(*) AS REQUEST_COUNT,
    AVG(res.DURATION_MS) AS AVG_DURATION_MS,
    MAX(res.DURATION_MS) AS MAX_DURATION_MS,
    MIN(res.DURATION_MS) AS MIN_DURATION_MS
FROM LOG_REQUEST_LOGS req
JOIN LOG_RESPONSE_LOGS res ON req.CORRELATION_ID = res.CORRELATION_ID
WHERE req.TIMESTAMP > SYSTIMESTAMP - INTERVAL '24' HOUR
GROUP BY TRUNC(req.TIMESTAMP, 'HH'), req.REQUEST_PATH
ORDER BY HOUR DESC, AVG_DURATION_MS DESC;

-- Kullanıcı aktivite özeti
CREATE OR REPLACE VIEW VW_USER_ACTIVITY AS
SELECT 
    USER_ID,
    COUNT(*) AS TOTAL_REQUESTS,
    MIN(TIMESTAMP) AS FIRST_REQUEST,
    MAX(TIMESTAMP) AS LAST_REQUEST
FROM LOG_REQUEST_LOGS
WHERE USER_ID IS NOT NULL
  AND TIMESTAMP > SYSTIMESTAMP - INTERVAL '7' DAY
GROUP BY USER_ID
ORDER BY TOTAL_REQUESTS DESC;

-- ============================================
-- SECTION 6: SEED DATA
-- ============================================

-- Demo Admin User (admin / Admin123!)
-- BCrypt Hash generated with cost factor 11
INSERT INTO USERS (USERNAME, PASSWORD_HASH, EMAIL, FULL_NAME, ROLES, IS_ACTIVE, CREATED_AT)
VALUES ('admin', '$2a$11$UcRiXou1e8p4CI/2SFNu3.cbl67H3dk3Qi8RoJpVwvnSsAbdJ8Jeu', 'admin@enterprise.com', 'System Administrator', 'Admin,User', 1, SYSTIMESTAMP);

-- Demo User (user / User123!)
INSERT INTO USERS (USERNAME, PASSWORD_HASH, EMAIL, FULL_NAME, ROLES, IS_ACTIVE, CREATED_AT)
VALUES ('user', '$2a$11$5j6SZSlEEN2VxkrORAmsoePChDpau9mCMB0Rj8Gd16QXd9nVvdclK', 'user@enterprise.com', 'Demo User', 'User', 1, SYSTIMESTAMP);

COMMIT;

-- ============================================
-- VERIFICATION
-- ============================================
SELECT 'Oracle schema created successfully' AS STATUS FROM DUAL;
SELECT 'Tables: CUSTOMERS, ORDERS, ORDER_ITEMS, USERS, REFRESH_TOKENS, LOG_*' AS INFO FROM DUAL;
SELECT 'Demo users: admin/Admin123!, user/User123!' AS CREDENTIALS FROM DUAL;

-- ============================================
-- NOTES
-- ============================================
-- BCrypt hash generation (C#):
--   using BCrypt.Net;
--   var hash = BCrypt.Net.BCrypt.HashPassword("Admin123!", BCrypt.Net.BCrypt.GenerateSalt(11));
--
-- Password verification (C#):
--   bool isValid = BCrypt.Net.BCrypt.Verify("Admin123!", hash);
-- ============================================

