-- ============================================
-- Oracle DDL Scripts
-- Enterprise Template
-- Version: 1.0.0
-- Date: 2025-01-01
-- ============================================

-- ============================================
-- BUSINESS TABLES
-- ============================================

-- CUSTOMERS Table (Oracle 12c+ Identity Column)
CREATE TABLE CUSTOMERS (
    ID                      NUMBER(19)      GENERATED BY DEFAULT AS IDENTITY NOT NULL,
    FIRST_NAME              VARCHAR2(100)   NOT NULL,
    LAST_NAME               VARCHAR2(100)   NOT NULL,
    EMAIL                   VARCHAR2(256)   NOT NULL,
    PHONE_NUMBER            VARCHAR2(20),
    IS_ACTIVE               NUMBER(1)       DEFAULT 1 NOT NULL,
    REGISTERED_AT           TIMESTAMP       NOT NULL,
    CREATED_AT              TIMESTAMP       NOT NULL,
    CREATED_BY              VARCHAR2(100),
    UPDATED_AT              TIMESTAMP,
    UPDATED_BY              VARCHAR2(100),
    IS_DELETED              NUMBER(1)       DEFAULT 0,
    DELETED_AT              TIMESTAMP,
    DELETED_BY              VARCHAR2(100),
    CONSTRAINT PK_CUSTOMERS PRIMARY KEY (ID)
);

COMMENT ON TABLE CUSTOMERS IS 'Müşteri bilgileri tablosu';
COMMENT ON COLUMN CUSTOMERS.ID IS 'Unique müşteri ID (Auto-increment)';
COMMENT ON COLUMN CUSTOMERS.FIRST_NAME IS 'Müşteri adı';
COMMENT ON COLUMN CUSTOMERS.LAST_NAME IS 'Müşteri soyadı';
COMMENT ON COLUMN CUSTOMERS.EMAIL IS 'E-posta adresi';
COMMENT ON COLUMN CUSTOMERS.PHONE_NUMBER IS 'Telefon numarası';
COMMENT ON COLUMN CUSTOMERS.IS_ACTIVE IS 'Aktif mi? (1=Evet, 0=Hayır)';
COMMENT ON COLUMN CUSTOMERS.REGISTERED_AT IS 'Kayıt tarihi';
COMMENT ON COLUMN CUSTOMERS.CREATED_AT IS 'Oluşturulma tarihi';
COMMENT ON COLUMN CUSTOMERS.CREATED_BY IS 'Oluşturan kullanıcı';
COMMENT ON COLUMN CUSTOMERS.UPDATED_AT IS 'Güncellenme tarihi';
COMMENT ON COLUMN CUSTOMERS.UPDATED_BY IS 'Güncelleyen kullanıcı';
COMMENT ON COLUMN CUSTOMERS.IS_DELETED IS 'Silinmiş mi? (Soft delete)';
COMMENT ON COLUMN CUSTOMERS.DELETED_AT IS 'Silinme tarihi';
COMMENT ON COLUMN CUSTOMERS.DELETED_BY IS 'Silen kullanıcı';

CREATE UNIQUE INDEX IDX_CUSTOMERS_EMAIL ON CUSTOMERS(EMAIL);
CREATE INDEX IDX_CUSTOMERS_IS_DELETED ON CUSTOMERS(IS_DELETED);
CREATE INDEX IDX_CUSTOMERS_IS_ACTIVE ON CUSTOMERS(IS_ACTIVE);

-- ============================================
-- LOG TABLES
-- ============================================

-- ============================================
-- 1. REQUEST LOGS
-- HTTP Request bilgilerini saklar
-- ============================================
CREATE TABLE LOG_REQUEST_LOGS (
    LOG_ID                  VARCHAR2(36)    NOT NULL,
    CORRELATION_ID          VARCHAR2(36)    NOT NULL,
    TIMESTAMP               TIMESTAMP       NOT NULL,
    HTTP_METHOD             VARCHAR2(10),
    REQUEST_PATH            VARCHAR2(2000),
    QUERY_STRING            VARCHAR2(4000),
    REQUEST_BODY            CLOB,
    REQUEST_HEADERS         CLOB,
    CONTENT_TYPE            VARCHAR2(200),
    CONTENT_LENGTH          NUMBER(19),
    CLIENT_IP               VARCHAR2(50),
    USER_AGENT              VARCHAR2(500),
    USER_ID                 VARCHAR2(100),
    LAYER                   VARCHAR2(50),
    SERVER_NAME             VARCHAR2(100),
    APPLICATION_NAME        VARCHAR2(100),
    CONSTRAINT PK_LOG_REQUEST_LOGS PRIMARY KEY (LOG_ID)
);

COMMENT ON TABLE LOG_REQUEST_LOGS IS 'HTTP Request log kayıtları';
COMMENT ON COLUMN LOG_REQUEST_LOGS.LOG_ID IS 'Unique log ID (GUID)';
COMMENT ON COLUMN LOG_REQUEST_LOGS.CORRELATION_ID IS 'Request correlation ID';
COMMENT ON COLUMN LOG_REQUEST_LOGS.TIMESTAMP IS 'Log oluşturulma zamanı';
COMMENT ON COLUMN LOG_REQUEST_LOGS.HTTP_METHOD IS 'HTTP metodu (GET, POST, PUT, DELETE, etc.)';
COMMENT ON COLUMN LOG_REQUEST_LOGS.REQUEST_PATH IS 'Request URL path';
COMMENT ON COLUMN LOG_REQUEST_LOGS.QUERY_STRING IS 'URL query string parametreleri';
COMMENT ON COLUMN LOG_REQUEST_LOGS.REQUEST_BODY IS 'Request body içeriği (JSON)';
COMMENT ON COLUMN LOG_REQUEST_LOGS.REQUEST_HEADERS IS 'Request headers (JSON)';
COMMENT ON COLUMN LOG_REQUEST_LOGS.CONTENT_TYPE IS 'Content-Type header değeri';
COMMENT ON COLUMN LOG_REQUEST_LOGS.CONTENT_LENGTH IS 'Content-Length header değeri';
COMMENT ON COLUMN LOG_REQUEST_LOGS.CLIENT_IP IS 'İstemci IP adresi';
COMMENT ON COLUMN LOG_REQUEST_LOGS.USER_AGENT IS 'User-Agent header değeri';
COMMENT ON COLUMN LOG_REQUEST_LOGS.USER_ID IS 'Authenticated kullanıcı ID';
COMMENT ON COLUMN LOG_REQUEST_LOGS.LAYER IS 'Uygulama katmanı (Server, Client, etc.)';
COMMENT ON COLUMN LOG_REQUEST_LOGS.SERVER_NAME IS 'Sunucu adı';
COMMENT ON COLUMN LOG_REQUEST_LOGS.APPLICATION_NAME IS 'Uygulama adı';

CREATE INDEX IDX_REQUEST_LOGS_CORRELATION ON LOG_REQUEST_LOGS(CORRELATION_ID);
CREATE INDEX IDX_REQUEST_LOGS_TIMESTAMP ON LOG_REQUEST_LOGS(TIMESTAMP);
CREATE INDEX IDX_REQUEST_LOGS_USER ON LOG_REQUEST_LOGS(USER_ID);
CREATE INDEX IDX_REQUEST_LOGS_PATH ON LOG_REQUEST_LOGS(REQUEST_PATH);

-- ============================================
-- 2. RESPONSE LOGS
-- HTTP Response bilgilerini saklar
-- ============================================
CREATE TABLE LOG_RESPONSE_LOGS (
    LOG_ID                  VARCHAR2(36)    NOT NULL,
    CORRELATION_ID          VARCHAR2(36)    NOT NULL,
    REQUEST_LOG_ID          VARCHAR2(36),
    TIMESTAMP               TIMESTAMP       NOT NULL,
    STATUS_CODE             NUMBER(5),
    DURATION_MS             NUMBER(19),
    RESPONSE_BODY           CLOB,
    CONTENT_TYPE            VARCHAR2(200),
    DB_QUERY_COUNT          NUMBER(10),
    DB_QUERY_DURATION_MS    NUMBER(19),
    CACHE_HIT_COUNT         NUMBER(10),
    CACHE_MISS_COUNT        NUMBER(10),
    LAYER                   VARCHAR2(50),
    SERVER_NAME             VARCHAR2(100),
    APPLICATION_NAME        VARCHAR2(100),
    CONSTRAINT PK_LOG_RESPONSE_LOGS PRIMARY KEY (LOG_ID)
);

COMMENT ON TABLE LOG_RESPONSE_LOGS IS 'HTTP Response log kayıtları';
COMMENT ON COLUMN LOG_RESPONSE_LOGS.LOG_ID IS 'Unique log ID (GUID)';
COMMENT ON COLUMN LOG_RESPONSE_LOGS.CORRELATION_ID IS 'Request correlation ID';
COMMENT ON COLUMN LOG_RESPONSE_LOGS.REQUEST_LOG_ID IS 'İlişkili request log ID';
COMMENT ON COLUMN LOG_RESPONSE_LOGS.TIMESTAMP IS 'Log oluşturulma zamanı';
COMMENT ON COLUMN LOG_RESPONSE_LOGS.STATUS_CODE IS 'HTTP status kodu';
COMMENT ON COLUMN LOG_RESPONSE_LOGS.DURATION_MS IS 'Request işleme süresi (ms)';
COMMENT ON COLUMN LOG_RESPONSE_LOGS.RESPONSE_BODY IS 'Response body içeriği';
COMMENT ON COLUMN LOG_RESPONSE_LOGS.CONTENT_TYPE IS 'Response Content-Type';
COMMENT ON COLUMN LOG_RESPONSE_LOGS.DB_QUERY_COUNT IS 'Veritabanı sorgu sayısı';
COMMENT ON COLUMN LOG_RESPONSE_LOGS.DB_QUERY_DURATION_MS IS 'Veritabanı sorgu süresi (ms)';
COMMENT ON COLUMN LOG_RESPONSE_LOGS.CACHE_HIT_COUNT IS 'Cache hit sayısı';
COMMENT ON COLUMN LOG_RESPONSE_LOGS.CACHE_MISS_COUNT IS 'Cache miss sayısı';
COMMENT ON COLUMN LOG_RESPONSE_LOGS.LAYER IS 'Uygulama katmanı';
COMMENT ON COLUMN LOG_RESPONSE_LOGS.SERVER_NAME IS 'Sunucu adı';
COMMENT ON COLUMN LOG_RESPONSE_LOGS.APPLICATION_NAME IS 'Uygulama adı';

CREATE INDEX IDX_RESPONSE_LOGS_CORRELATION ON LOG_RESPONSE_LOGS(CORRELATION_ID);
CREATE INDEX IDX_RESPONSE_LOGS_REQUEST ON LOG_RESPONSE_LOGS(REQUEST_LOG_ID);
CREATE INDEX IDX_RESPONSE_LOGS_TIMESTAMP ON LOG_RESPONSE_LOGS(TIMESTAMP);
CREATE INDEX IDX_RESPONSE_LOGS_STATUS ON LOG_RESPONSE_LOGS(STATUS_CODE);
CREATE INDEX IDX_RESPONSE_LOGS_DURATION ON LOG_RESPONSE_LOGS(DURATION_MS);

-- ============================================
-- 3. EXCEPTION LOGS
-- Sistem hatalarını saklar
-- ============================================
CREATE TABLE LOG_EXCEPTION_LOGS (
    LOG_ID                  VARCHAR2(36)    NOT NULL,
    CORRELATION_ID          VARCHAR2(36)    NOT NULL,
    TIMESTAMP               TIMESTAMP       NOT NULL,
    LOG_LEVEL               VARCHAR2(20),
    EXCEPTION_TYPE          VARCHAR2(500),
    EXCEPTION_MESSAGE       VARCHAR2(4000),
    STACK_TRACE             CLOB,
    SOURCE                  VARCHAR2(500),
    INNER_EXCEPTION_TYPE    VARCHAR2(500),
    INNER_EXCEPTION_MESSAGE VARCHAR2(4000),
    LAYER                   VARCHAR2(50),
    CLASS_NAME              VARCHAR2(500),
    METHOD_NAME             VARCHAR2(200),
    REQUEST_PATH            VARCHAR2(2000),
    HTTP_METHOD             VARCHAR2(10),
    EXCEPTION_CATEGORY      VARCHAR2(100),
    IS_HANDLED              NUMBER(1),
    IS_TRANSIENT            NUMBER(1),
    SERVER_NAME             VARCHAR2(100),
    CLIENT_IP               VARCHAR2(50),
    USER_ID                 VARCHAR2(100),
    APPLICATION_NAME        VARCHAR2(100),
    CONSTRAINT PK_LOG_EXCEPTION_LOGS PRIMARY KEY (LOG_ID)
);

COMMENT ON TABLE LOG_EXCEPTION_LOGS IS 'Exception/Hata log kayıtları';
COMMENT ON COLUMN LOG_EXCEPTION_LOGS.LOG_ID IS 'Unique log ID (GUID)';
COMMENT ON COLUMN LOG_EXCEPTION_LOGS.CORRELATION_ID IS 'Request correlation ID';
COMMENT ON COLUMN LOG_EXCEPTION_LOGS.TIMESTAMP IS 'Hata oluşma zamanı';
COMMENT ON COLUMN LOG_EXCEPTION_LOGS.LOG_LEVEL IS 'Log seviyesi (Error, Critical, Warning)';
COMMENT ON COLUMN LOG_EXCEPTION_LOGS.EXCEPTION_TYPE IS 'Exception tipi (full type name)';
COMMENT ON COLUMN LOG_EXCEPTION_LOGS.EXCEPTION_MESSAGE IS 'Exception mesajı';
COMMENT ON COLUMN LOG_EXCEPTION_LOGS.STACK_TRACE IS 'Stack trace';
COMMENT ON COLUMN LOG_EXCEPTION_LOGS.SOURCE IS 'Hata kaynağı';
COMMENT ON COLUMN LOG_EXCEPTION_LOGS.INNER_EXCEPTION_TYPE IS 'Inner exception tipi';
COMMENT ON COLUMN LOG_EXCEPTION_LOGS.INNER_EXCEPTION_MESSAGE IS 'Inner exception mesajı';
COMMENT ON COLUMN LOG_EXCEPTION_LOGS.LAYER IS 'Uygulama katmanı';
COMMENT ON COLUMN LOG_EXCEPTION_LOGS.CLASS_NAME IS 'Hatanın oluştuğu sınıf';
COMMENT ON COLUMN LOG_EXCEPTION_LOGS.METHOD_NAME IS 'Hatanın oluştuğu metod';
COMMENT ON COLUMN LOG_EXCEPTION_LOGS.REQUEST_PATH IS 'İlişkili request path';
COMMENT ON COLUMN LOG_EXCEPTION_LOGS.HTTP_METHOD IS 'İlişkili HTTP metodu';
COMMENT ON COLUMN LOG_EXCEPTION_LOGS.EXCEPTION_CATEGORY IS 'Hata kategorisi';
COMMENT ON COLUMN LOG_EXCEPTION_LOGS.IS_HANDLED IS 'Hata yakalandı mı? (1=Evet, 0=Hayır)';
COMMENT ON COLUMN LOG_EXCEPTION_LOGS.IS_TRANSIENT IS 'Geçici hata mı? (1=Evet, 0=Hayır)';
COMMENT ON COLUMN LOG_EXCEPTION_LOGS.SERVER_NAME IS 'Sunucu adı';
COMMENT ON COLUMN LOG_EXCEPTION_LOGS.CLIENT_IP IS 'İstemci IP adresi';
COMMENT ON COLUMN LOG_EXCEPTION_LOGS.USER_ID IS 'Kullanıcı ID';
COMMENT ON COLUMN LOG_EXCEPTION_LOGS.APPLICATION_NAME IS 'Uygulama adı';

CREATE INDEX IDX_EXCEPTION_LOGS_CORRELATION ON LOG_EXCEPTION_LOGS(CORRELATION_ID);
CREATE INDEX IDX_EXCEPTION_LOGS_TIMESTAMP ON LOG_EXCEPTION_LOGS(TIMESTAMP);
CREATE INDEX IDX_EXCEPTION_LOGS_TYPE ON LOG_EXCEPTION_LOGS(EXCEPTION_TYPE);
CREATE INDEX IDX_EXCEPTION_LOGS_LEVEL ON LOG_EXCEPTION_LOGS(LOG_LEVEL);
CREATE INDEX IDX_EXCEPTION_LOGS_CATEGORY ON LOG_EXCEPTION_LOGS(EXCEPTION_CATEGORY);

-- ============================================
-- 4. BUSINESS EXCEPTION LOGS
-- İş kuralı hatalarını saklar
-- ============================================
CREATE TABLE LOG_BUSINESS_EXCEPTION_LOGS (
    LOG_ID                  VARCHAR2(36)    NOT NULL,
    CORRELATION_ID          VARCHAR2(36)    NOT NULL,
    TIMESTAMP               TIMESTAMP       NOT NULL,
    BUSINESS_OPERATION      VARCHAR2(200),
    BUSINESS_ERROR_CODE     VARCHAR2(50),
    BUSINESS_ERROR_MESSAGE  VARCHAR2(4000),
    USER_FRIENDLY_MESSAGE   VARCHAR2(2000),
    SUGGESTED_ACTION        VARCHAR2(1000),
    AFFECTED_ENTITY         VARCHAR2(200),
    AFFECTED_ENTITY_ID      VARCHAR2(100),
    RULE_NAME               VARCHAR2(200),
    VALIDATION_ERRORS       CLOB,
    LAYER                   VARCHAR2(50),
    CLASS_NAME              VARCHAR2(500),
    SERVER_NAME             VARCHAR2(100),
    CLIENT_IP               VARCHAR2(50),
    USER_ID                 VARCHAR2(100),
    APPLICATION_NAME        VARCHAR2(100),
    CONSTRAINT PK_LOG_BUSINESS_EXCEPTION PRIMARY KEY (LOG_ID)
);

COMMENT ON TABLE LOG_BUSINESS_EXCEPTION_LOGS IS 'İş kuralı hata log kayıtları';
COMMENT ON COLUMN LOG_BUSINESS_EXCEPTION_LOGS.LOG_ID IS 'Unique log ID (GUID)';
COMMENT ON COLUMN LOG_BUSINESS_EXCEPTION_LOGS.CORRELATION_ID IS 'Request correlation ID';
COMMENT ON COLUMN LOG_BUSINESS_EXCEPTION_LOGS.TIMESTAMP IS 'Hata oluşma zamanı';
COMMENT ON COLUMN LOG_BUSINESS_EXCEPTION_LOGS.BUSINESS_OPERATION IS 'İş operasyonu adı';
COMMENT ON COLUMN LOG_BUSINESS_EXCEPTION_LOGS.BUSINESS_ERROR_CODE IS 'İş hatası kodu';
COMMENT ON COLUMN LOG_BUSINESS_EXCEPTION_LOGS.BUSINESS_ERROR_MESSAGE IS 'İş hatası mesajı';
COMMENT ON COLUMN LOG_BUSINESS_EXCEPTION_LOGS.USER_FRIENDLY_MESSAGE IS 'Kullanıcı dostu hata mesajı';
COMMENT ON COLUMN LOG_BUSINESS_EXCEPTION_LOGS.SUGGESTED_ACTION IS 'Önerilen aksiyon';
COMMENT ON COLUMN LOG_BUSINESS_EXCEPTION_LOGS.AFFECTED_ENTITY IS 'Etkilenen entity tipi';
COMMENT ON COLUMN LOG_BUSINESS_EXCEPTION_LOGS.AFFECTED_ENTITY_ID IS 'Etkilenen entity ID';
COMMENT ON COLUMN LOG_BUSINESS_EXCEPTION_LOGS.RULE_NAME IS 'İhlal edilen kural adı';
COMMENT ON COLUMN LOG_BUSINESS_EXCEPTION_LOGS.VALIDATION_ERRORS IS 'Validation hataları (JSON)';
COMMENT ON COLUMN LOG_BUSINESS_EXCEPTION_LOGS.LAYER IS 'Uygulama katmanı';
COMMENT ON COLUMN LOG_BUSINESS_EXCEPTION_LOGS.CLASS_NAME IS 'Hatanın oluştuğu sınıf';
COMMENT ON COLUMN LOG_BUSINESS_EXCEPTION_LOGS.SERVER_NAME IS 'Sunucu adı';
COMMENT ON COLUMN LOG_BUSINESS_EXCEPTION_LOGS.CLIENT_IP IS 'İstemci IP adresi';
COMMENT ON COLUMN LOG_BUSINESS_EXCEPTION_LOGS.USER_ID IS 'Kullanıcı ID';
COMMENT ON COLUMN LOG_BUSINESS_EXCEPTION_LOGS.APPLICATION_NAME IS 'Uygulama adı';

CREATE INDEX IDX_BUS_EXC_LOGS_CORRELATION ON LOG_BUSINESS_EXCEPTION_LOGS(CORRELATION_ID);
CREATE INDEX IDX_BUS_EXC_LOGS_TIMESTAMP ON LOG_BUSINESS_EXCEPTION_LOGS(TIMESTAMP);
CREATE INDEX IDX_BUS_EXC_LOGS_ERROR_CODE ON LOG_BUSINESS_EXCEPTION_LOGS(BUSINESS_ERROR_CODE);
CREATE INDEX IDX_BUS_EXC_LOGS_OPERATION ON LOG_BUSINESS_EXCEPTION_LOGS(BUSINESS_OPERATION);
CREATE INDEX IDX_BUS_EXC_LOGS_ENTITY ON LOG_BUSINESS_EXCEPTION_LOGS(AFFECTED_ENTITY, AFFECTED_ENTITY_ID);

-- ============================================
-- 5. AUDIT LOGS
-- Veri değişiklik kayıtlarını saklar
-- ============================================
CREATE TABLE LOG_AUDIT_LOGS (
    LOG_ID                  VARCHAR2(36)    NOT NULL,
    CORRELATION_ID          VARCHAR2(36)    NOT NULL,
    TIMESTAMP               TIMESTAMP       NOT NULL,
    ACTION                  VARCHAR2(50),
    ENTITY_TYPE             VARCHAR2(200),
    ENTITY_ID               VARCHAR2(100),
    OLD_VALUES              CLOB,
    NEW_VALUES              CLOB,
    CHANGES                 CLOB,
    IS_SUCCESS              NUMBER(1),
    FAILURE_REASON          VARCHAR2(2000),
    DURATION_MS             NUMBER(19),
    LAYER                   VARCHAR2(50),
    USER_ID                 VARCHAR2(100),
    CLIENT_IP               VARCHAR2(50),
    SERVER_NAME             VARCHAR2(100),
    APPLICATION_NAME        VARCHAR2(100),
    CONSTRAINT PK_LOG_AUDIT_LOGS PRIMARY KEY (LOG_ID)
);

COMMENT ON TABLE LOG_AUDIT_LOGS IS 'Audit/Denetim log kayıtları';
COMMENT ON COLUMN LOG_AUDIT_LOGS.LOG_ID IS 'Unique log ID (GUID)';
COMMENT ON COLUMN LOG_AUDIT_LOGS.CORRELATION_ID IS 'Request correlation ID';
COMMENT ON COLUMN LOG_AUDIT_LOGS.TIMESTAMP IS 'İşlem zamanı';
COMMENT ON COLUMN LOG_AUDIT_LOGS.ACTION IS 'İşlem tipi (Create, Update, Delete, Read)';
COMMENT ON COLUMN LOG_AUDIT_LOGS.ENTITY_TYPE IS 'Entity tipi';
COMMENT ON COLUMN LOG_AUDIT_LOGS.ENTITY_ID IS 'Entity ID';
COMMENT ON COLUMN LOG_AUDIT_LOGS.OLD_VALUES IS 'Eski değerler (JSON)';
COMMENT ON COLUMN LOG_AUDIT_LOGS.NEW_VALUES IS 'Yeni değerler (JSON)';
COMMENT ON COLUMN LOG_AUDIT_LOGS.CHANGES IS 'Değişiklikler (JSON)';
COMMENT ON COLUMN LOG_AUDIT_LOGS.IS_SUCCESS IS 'İşlem başarılı mı? (1=Evet, 0=Hayır)';
COMMENT ON COLUMN LOG_AUDIT_LOGS.FAILURE_REASON IS 'Başarısızlık nedeni';
COMMENT ON COLUMN LOG_AUDIT_LOGS.DURATION_MS IS 'İşlem süresi (ms)';
COMMENT ON COLUMN LOG_AUDIT_LOGS.LAYER IS 'Uygulama katmanı';
COMMENT ON COLUMN LOG_AUDIT_LOGS.USER_ID IS 'İşlemi yapan kullanıcı ID';
COMMENT ON COLUMN LOG_AUDIT_LOGS.CLIENT_IP IS 'İstemci IP adresi';
COMMENT ON COLUMN LOG_AUDIT_LOGS.SERVER_NAME IS 'Sunucu adı';
COMMENT ON COLUMN LOG_AUDIT_LOGS.APPLICATION_NAME IS 'Uygulama adı';

CREATE INDEX IDX_AUDIT_LOGS_CORRELATION ON LOG_AUDIT_LOGS(CORRELATION_ID);
CREATE INDEX IDX_AUDIT_LOGS_TIMESTAMP ON LOG_AUDIT_LOGS(TIMESTAMP);
CREATE INDEX IDX_AUDIT_LOGS_ENTITY ON LOG_AUDIT_LOGS(ENTITY_TYPE, ENTITY_ID);
CREATE INDEX IDX_AUDIT_LOGS_USER ON LOG_AUDIT_LOGS(USER_ID);
CREATE INDEX IDX_AUDIT_LOGS_ACTION ON LOG_AUDIT_LOGS(ACTION);

-- ============================================
-- SEQUENCES (Opsiyonel - ID generation için)
-- ============================================
-- Not: Tablolar GUID kullanıyor, sequence gerekmez
-- Ancak numeric ID tercih edilirse:
/*
CREATE SEQUENCE SEQ_LOG_REQUEST_LOGS START WITH 1 INCREMENT BY 1 NOCACHE;
CREATE SEQUENCE SEQ_LOG_RESPONSE_LOGS START WITH 1 INCREMENT BY 1 NOCACHE;
CREATE SEQUENCE SEQ_LOG_EXCEPTION_LOGS START WITH 1 INCREMENT BY 1 NOCACHE;
CREATE SEQUENCE SEQ_LOG_BUSINESS_EXCEPTION_LOGS START WITH 1 INCREMENT BY 1 NOCACHE;
CREATE SEQUENCE SEQ_LOG_AUDIT_LOGS START WITH 1 INCREMENT BY 1 NOCACHE;
*/

-- ============================================
-- PARTITIONING (Büyük veri için önerilir)
-- ============================================
-- Örnek: Monthly partition ile REQUEST_LOGS tablosu
/*
DROP TABLE LOG_REQUEST_LOGS;

CREATE TABLE LOG_REQUEST_LOGS (
    LOG_ID                  VARCHAR2(36)    NOT NULL,
    CORRELATION_ID          VARCHAR2(36)    NOT NULL,
    TIMESTAMP               TIMESTAMP       NOT NULL,
    HTTP_METHOD             VARCHAR2(10),
    REQUEST_PATH            VARCHAR2(2000),
    QUERY_STRING            VARCHAR2(4000),
    REQUEST_BODY            CLOB,
    REQUEST_HEADERS         CLOB,
    CONTENT_TYPE            VARCHAR2(200),
    CONTENT_LENGTH          NUMBER(19),
    CLIENT_IP               VARCHAR2(50),
    USER_AGENT              VARCHAR2(500),
    USER_ID                 VARCHAR2(100),
    LAYER                   VARCHAR2(50),
    SERVER_NAME             VARCHAR2(100),
    APPLICATION_NAME        VARCHAR2(100),
    CONSTRAINT PK_LOG_REQUEST_LOGS PRIMARY KEY (LOG_ID, TIMESTAMP)
)
PARTITION BY RANGE (TIMESTAMP)
INTERVAL (NUMTOYMINTERVAL(1, 'MONTH'))
(
    PARTITION P_INITIAL VALUES LESS THAN (TO_TIMESTAMP('2025-01-01', 'YYYY-MM-DD'))
);
*/

-- ============================================
-- DATA RETENTION (Eski veri temizliği)
-- ============================================
-- 90 günden eski logları silen procedure
/*
CREATE OR REPLACE PROCEDURE SP_CLEANUP_OLD_LOGS(p_retention_days IN NUMBER DEFAULT 90) AS
    v_cutoff_date TIMESTAMP;
BEGIN
    v_cutoff_date := SYSTIMESTAMP - p_retention_days;
    
    DELETE FROM LOG_REQUEST_LOGS WHERE TIMESTAMP < v_cutoff_date;
    DELETE FROM LOG_RESPONSE_LOGS WHERE TIMESTAMP < v_cutoff_date;
    DELETE FROM LOG_EXCEPTION_LOGS WHERE TIMESTAMP < v_cutoff_date;
    DELETE FROM LOG_BUSINESS_EXCEPTION_LOGS WHERE TIMESTAMP < v_cutoff_date;
    DELETE FROM LOG_AUDIT_LOGS WHERE TIMESTAMP < v_cutoff_date;
    
    COMMIT;
    
    DBMS_OUTPUT.PUT_LINE('Deleted logs older than ' || TO_CHAR(v_cutoff_date, 'YYYY-MM-DD HH24:MI:SS'));
EXCEPTION
    WHEN OTHERS THEN
        ROLLBACK;
        RAISE;
END;
/
*/

-- ============================================
-- GRANTS
-- ============================================
-- Uygulama kullanıcısına gerekli yetkiler
/*
GRANT SELECT, INSERT ON LOG_REQUEST_LOGS TO enterprise_app;
GRANT SELECT, INSERT ON LOG_RESPONSE_LOGS TO enterprise_app;
GRANT SELECT, INSERT ON LOG_EXCEPTION_LOGS TO enterprise_app;
GRANT SELECT, INSERT ON LOG_BUSINESS_EXCEPTION_LOGS TO enterprise_app;
GRANT SELECT, INSERT ON LOG_AUDIT_LOGS TO enterprise_app;

-- Read-only kullanıcı için
GRANT SELECT ON LOG_REQUEST_LOGS TO enterprise_readonly;
GRANT SELECT ON LOG_RESPONSE_LOGS TO enterprise_readonly;
GRANT SELECT ON LOG_EXCEPTION_LOGS TO enterprise_readonly;
GRANT SELECT ON LOG_BUSINESS_EXCEPTION_LOGS TO enterprise_readonly;
GRANT SELECT ON LOG_AUDIT_LOGS TO enterprise_readonly;
*/

-- ============================================
-- VIEWS (Raporlama için)
-- ============================================

-- Son 24 saat hata özeti
CREATE OR REPLACE VIEW VW_EXCEPTION_SUMMARY_24H AS
SELECT 
    TRUNC(TIMESTAMP, 'HH') AS HOUR,
    EXCEPTION_TYPE,
    LOG_LEVEL,
    COUNT(*) AS ERROR_COUNT
FROM LOG_EXCEPTION_LOGS
WHERE TIMESTAMP > SYSTIMESTAMP - INTERVAL '24' HOUR
GROUP BY TRUNC(TIMESTAMP, 'HH'), EXCEPTION_TYPE, LOG_LEVEL
ORDER BY HOUR DESC, ERROR_COUNT DESC;

-- Request performans özeti
CREATE OR REPLACE VIEW VW_REQUEST_PERFORMANCE AS
SELECT 
    TRUNC(req.TIMESTAMP, 'HH') AS HOUR,
    req.REQUEST_PATH,
    COUNT(*) AS REQUEST_COUNT,
    AVG(res.DURATION_MS) AS AVG_DURATION_MS,
    MAX(res.DURATION_MS) AS MAX_DURATION_MS,
    MIN(res.DURATION_MS) AS MIN_DURATION_MS
FROM LOG_REQUEST_LOGS req
JOIN LOG_RESPONSE_LOGS res ON req.CORRELATION_ID = res.CORRELATION_ID
WHERE req.TIMESTAMP > SYSTIMESTAMP - INTERVAL '24' HOUR
GROUP BY TRUNC(req.TIMESTAMP, 'HH'), req.REQUEST_PATH
ORDER BY HOUR DESC, AVG_DURATION_MS DESC;

-- Kullanıcı aktivite özeti
CREATE OR REPLACE VIEW VW_USER_ACTIVITY AS
SELECT 
    USER_ID,
    COUNT(*) AS TOTAL_REQUESTS,
    MIN(TIMESTAMP) AS FIRST_REQUEST,
    MAX(TIMESTAMP) AS LAST_REQUEST
FROM LOG_REQUEST_LOGS
WHERE USER_ID IS NOT NULL
  AND TIMESTAMP > SYSTIMESTAMP - INTERVAL '7' DAY
GROUP BY USER_ID
ORDER BY TOTAL_REQUESTS DESC;

